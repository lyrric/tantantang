<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·é…ç½®ç®¡ç†</title>
    <!-- å¼•å…¥ Vue.js -->
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <!-- å¼•å…¥ Element UI æ ·å¼ -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- å¼•å…¥ Font Awesome å›¾æ ‡ -->
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <!-- å¼•å…¥è‡ªå®šä¹‰æ ·å¼ -->
    <link rel="stylesheet" href="css/user-config.css">
    <!-- å¼•å…¥ Element UI ç»„ä»¶åº“ -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
</head>
<body>
<div id="app" class="container">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="/user-config.html" class="navbar-brand">
            æ¢æ¢ç³–æ´»åŠ¨å¹³å°
        </a>
        <div class="navbar-nav">
            <a href="user-config.html" class="nav-link active">
                ğŸ  ç”¨æˆ·é…ç½®
            </a>
            <a href="activity-list.html" class="nav-link">
                ğŸ æ´»åŠ¨åˆ—è¡¨
            </a>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <el-card class="mt-4" style="border-radius: 12px; border: none; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);"
             v-loading="loading">
        <div slot="header" class="card-header">
            <span>ç”¨æˆ·é…ç½®ç®¡ç†</span>
            <div style="display: flex; gap: 10px;">
                <el-button class="add-address-btn" @click="openAddDialog"
                           style="display: flex; align-items: center; gap: 5px;">
                    <i class="fa fa-plus"></i> æ–°å¢
                </el-button>
                <el-button class="add-address-btn" @click="fetchUserConfigs" :disabled="loading"
                           style="display: flex; align-items: center; gap: 5px;">
                    <i class="fa fa-refresh"></i> åˆ·æ–°
                </el-button>
            </div>
        </div>

        <div v-if="userConfigs.length === 0" class="empty-state">
            <el-empty description="æš‚æ— ç”¨æˆ·é…ç½®">
                <el-button class="add-address-btn" @click="fetchUserConfigs" slot="bottom">
                    <i class="fa fa-refresh"></i> åˆ·æ–°åˆ—è¡¨
                </el-button>
            </el-empty>
        </div>

        <!-- ç”¨æˆ·é…ç½®å¡ç‰‡ -->
        <div v-else class="cards-container mt-4">
            <el-card
                    v-for="(config, index) in userConfigs"
                    :key="config.user_id"
                    class="user-config-card"
                    :style="{animationDelay: (index * 0.1) + 's'}"
            >
                <div>
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fa fa-user"></i> {{ config.name }}
                        </div>
                    </div>

                    <div class="card-content">
                        <div class="info-item">
                            <i class="fa fa-id-card"></i>
                            <span class="info-label">ç”¨æˆ·ID:</span>
                            <span class="info-value">{{ config.user_id }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fa fa-map-marker"></i>
                            <span class="info-label">åŸå¸‚:</span>
                            <span class="info-value">{{ config.city || 'æœªè®¾ç½®' }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fa fa-line-chart"></i>
                            <span class="info-label">ç ä»·çŠ¶æ€:</span>
                            <span class="info-value">
                                <el-tag size="small" :type="getStatusType(config.bar_gain_state?.status)">
                                    {{ getStatusText(config.bar_gain_state?.status) }}
                                </el-tag>
                            </span>
                        </div>
                    </div>

                    <div class="card-footer">
                        <el-button size="small" class="edit-btn" @click="openEditDialog(config)" :disabled="loading"
                                   style="display: flex; align-items: center; gap: 3px;">
                            <i class="fa fa-edit"></i> ç¼–è¾‘
                        </el-button>
                        <el-button size="small" class="delete-btn" @click="deleteUserConfig(config.user_id)"
                                   :disabled="loading" style="display: flex; align-items: center; gap: 3px;">
                            <i class="fa fa-trash"></i> åˆ é™¤
                        </el-button>
                        <el-button size="small" class="run-btn" @click="startBargain(config.user_id)"
                                   :disabled="loading" style="display: flex; align-items: center; gap: 3px;">
                            <i class="fa fa-play-circle"></i> è¿è¡Œ
                        </el-button>
                    </div>
                </div>
            </el-card>
        </div>
    </el-card>

    <!-- æ–°å¢/ç¼–è¾‘å¯¹è¯æ¡† -->
    <el-dialog :title="dialogTitle" :visible.sync="dialogVisible" width="90%" max-width="500px"
               @close="handleDialogClose">
        <el-form :model="currentConfig" label-width="80px">
            <el-form-item label="Token">
                <el-input v-model="currentConfig.token" placeholder="è¯·è¾“å…¥Token"></el-input>
            </el-form-item>
            <el-form-item label="åŸå¸‚">
                <el-input v-model="currentConfig.city" placeholder="è¯·è¾“å…¥åŸå¸‚"></el-input>
            </el-form-item>
            <el-form-item label="SPT">
                <el-input v-model="currentConfig.spt" placeholder="è¯·è¾“å…¥SPT"></el-input>
            </el-form-item>
            <el-row :gutter="20">
                <el-col :span="12">
                    <el-form-item label="ç»åº¦">
                        <el-input v-model.number="currentConfig.lnt" placeholder="è¯·è¾“å…¥ç»åº¦"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="12">
                    <el-form-item label="çº¬åº¦">
                        <el-input v-model.number="currentConfig.lat" placeholder="è¯·è¾“å…¥çº¬åº¦"></el-input>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-form-item label="Key">
                <el-input v-model="currentConfig.key" placeholder="è¯·è¾“å…¥Key"></el-input>
            </el-form-item>
        </el-form>
        <span slot="footer" class="dialog-footer">
            <el-button @click="dialogVisible = false">å– æ¶ˆ</el-button>
            <el-button type="primary" @click="saveUserConfig" :loading="submitLoading">ç¡® å®š</el-button>
            <el-button v-if="isEditing" type="success" @click="saveUserConfigAndRun"
                       :loading="submitLoading">ä¿å­˜å¹¶è¿è¡Œ</el-button>
        </span>
    </el-dialog>
</div>

<script>
    new Vue({
        el: '#app',
        data() {
            return {
                userConfigs: [],
                dialogVisible: false,
                isEditing: false,
                loading: false,
                submitLoading: false,
                currentConfig: {
                    name: '',
                    user_id: null,
                    token: '',
                    city: '',
                    spt: '',
                    lnt: null,
                    lat: null,
                    key: ''
                }
            }
        },
        computed: {
            dialogTitle() {
                return this.isEditing ? 'ç¼–è¾‘ç”¨æˆ·é…ç½®' : 'æ–°å¢ç”¨æˆ·é…ç½®'
            }
        },
        mounted() {
            this.fetchUserConfigs()
        },
        methods: {
            // è·å–æ‰€æœ‰ç”¨æˆ·é…ç½®
            async fetchUserConfigs() {
                this.loading = true;
                try {
                    const response = await fetch('/ttt/user-configs')
                    const result = await response.json()
                    if (result.code === 200) {
                        this.userConfigs = result.data || []
                    } else {
                        this.$message.error(result.msg || 'è·å–ç”¨æˆ·é…ç½®å¤±è´¥')
                    }
                } catch (error) {
                    this.$message.error('ç½‘ç»œé”™è¯¯: ' + error.message)
                } finally {
                    this.loading = false;
                }
            },

            // æ‰“å¼€æ–°å¢å¯¹è¯æ¡†
            openAddDialog() {
                this.isEditing = false
                this.currentConfig = {
                    name: '',
                    token: '',
                    city: '',
                    spt: '',
                    lnt: null,
                    lat: null,
                    key: ''
                }
                this.dialogVisible = true
            },

            // æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
            openEditDialog(config) {
                this.isEditing = true
                // æ·±æ‹·è´é¿å…ä¿®æ”¹åŸæ•°æ®
                this.currentConfig = JSON.parse(JSON.stringify(config))
                this.dialogVisible = true
            },

            // å¯¹è¯æ¡†å…³é—­å›è°ƒ
            handleDialogClose() {
                // å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›æ¸…ç†å·¥ä½œ
            },

            // ä¿å­˜ç”¨æˆ·é…ç½®
            async saveUserConfig() {
                await this.saveUserConfigInternal(false);
            },

            // ä¿å­˜ç”¨æˆ·é…ç½®å¹¶è¿è¡Œ
            async saveUserConfigAndRun() {
                await this.saveUserConfigInternal(true);
            },

            // ä¿å­˜ç”¨æˆ·é…ç½®çš„å†…éƒ¨æ–¹æ³•
            async saveUserConfigInternal(start) {
                this.submitLoading = true;
                try {
                    let response
                    if (this.isEditing) {
                        // æ·»åŠ startå‚æ•°åˆ°currentConfig
                        const configToSend = {
                            ...this.currentConfig,
                            start: start
                        };

                        // ç¼–è¾‘
                        response = await fetch(`/ttt/user-configs/${this.currentConfig.user_id}/update`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(configToSend)
                        })
                    } else {
                        // æ–°å¢
                        response = await fetch('/ttt/user-configs/create', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.currentConfig)
                        })
                    }

                    const result = await response.json()
                    if (result.code === 200) {
                        this.$message.success(this.isEditing ? 'ç¼–è¾‘æˆåŠŸ' : 'æ–°å¢æˆåŠŸ')
                        this.dialogVisible = false
                        this.fetchUserConfigs()
                    } else {
                        this.$message.error(result.msg || (this.isEditing ? 'ç¼–è¾‘å¤±è´¥' : 'æ–°å¢å¤±è´¥'))
                    }
                } catch (error) {
                    this.$message.error('ç½‘ç»œé”™è¯¯: ' + error.message)
                } finally {
                    this.submitLoading = false;
                }
            },

            // åˆ é™¤ç”¨æˆ·é…ç½®
            deleteUserConfig(userId) {
                this.$confirm('æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤è¯¥ç”¨æˆ·é…ç½®, æ˜¯å¦ç»§ç»­?', 'æç¤º', {
                    confirmButtonText: 'ç¡®å®š',
                    cancelButtonText: 'å–æ¶ˆ',
                    type: 'warning'
                }).then(async () => {
                    this.loading = true;
                    try {
                        const response = await fetch(`/ttt/user-configs/${userId}/delete`, {
                            method: 'DELETE'
                        })
                        const result = await response.json()
                        if (result.code === 200) {
                            this.$message.success('åˆ é™¤æˆåŠŸ')
                            this.fetchUserConfigs()
                        } else {
                            this.$message.error(result.msg || 'åˆ é™¤å¤±è´¥')
                        }
                    } catch (error) {
                        this.$message.error('ç½‘ç»œé”™è¯¯: ' + error.message)
                    } finally {
                        this.loading = false;
                    }
                }).catch(() => {
                    this.$message.info('å·²å–æ¶ˆåˆ é™¤')
                })
            },

            // ç«‹å³è¿è¡Œç ä»·
            async startBargain(userId) {
                this.loading = true;
                try {
                    const response = await fetch(`/ttt/user-configs/${userId}/start`, {
                        method: 'POST'
                    })
                    const result = await response.json()
                    if (result.code === 200) {
                        this.$message.success('å·²å¯åŠ¨ç ä»·ä»»åŠ¡')
                    } else {
                        this.$message.error(result.msg || 'å¯åŠ¨å¤±è´¥')
                    }
                } catch (error) {
                    this.$message.error('ç½‘ç»œé”™è¯¯: ' + error.message)
                } finally {
                    this.loading = false;
                }
            },

            // è·å–ç ä»·çŠ¶æ€æ–‡æœ¬
            getStatusText(status) {
                const statusMap = {
                    1: 'æœªå¼€å§‹',
                    2: 'è¿›è¡Œä¸­',
                    3: 'æš‚åœ',
                    4: 'å·²å®Œæˆ'
                }
                return statusMap[status] || 'æœªçŸ¥çŠ¶æ€'
            },

            // è·å–çŠ¶æ€æ ·å¼ç±»å‹
            getStatusType(status) {
                switch (status) {
                    case 1:
                        return 'info';     // æœªå¼€å§‹
                    case 2:
                        return 'success';  // è¿›è¡Œä¸­
                    case 3:
                        return 'warning';  // æš‚åœ
                    case 4:
                        return 'danger';   // å·²å®Œæˆ
                    default:
                        return 'info';
                }
            }
        }
    })
</script>
</body>
</html>