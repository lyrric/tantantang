<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ê¥ªÂä®ÂàóË°®</title>
    <!-- ÂºïÂÖ• Vue.js -->
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <!-- ÂºïÂÖ• Element UI Ê†∑Âºè -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- ÂºïÂÖ• Font Awesome ÂõæÊ†á -->
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <!-- ÂºïÂÖ•Ëá™ÂÆö‰πâÊ†∑Âºè -->
    <link rel="stylesheet" href="css/user-config.css">
    <!-- ÂºïÂÖ• Element UI ÁªÑ‰ª∂Â∫ì -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <style>
        .cards-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 1200px) {
            .cards-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .cards-container {
                grid-template-columns: 1fr;
            }
        }

        .user-config-card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .user-config-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .activity-card {
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 15px;
            padding: 20px;
        }

        .activity-image {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
        }

        .activity-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .activity-title {
            font-size: 16px;
            font-weight: 600;
            color: #303133;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            white-space: normal;
            line-height: 1.4;
        }

        .activity-info {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .info-item {
            display: flex;
            align-items: center;
            font-size: 13px;
            color: #666;
        }

        .info-item i {
            margin-right: 5px;
            color: #888;
        }

        .price-container {
            display: flex;
            align-items: baseline;
            gap: 10px;
            margin-top: 5px;
        }

        .current-price {
            font-size: 18px;
            font-weight: bold;
            color: #f56c6c;
        }

        .original-price {
            font-size: 14px;
            color: #999;
            text-decoration: line-through;
        }

        .activity-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-sold-out {
            background-color: #f4f4f5 !important;
            border-color: #e9e9eb !important;
            color: #c0c4cc !important;
            cursor: not-allowed !important;
        }

        .btn-bargain {
            background-color: #fdf6ec !important;
            border-color: #f5dab1 !important;
            color: #e6a23c !important;
        }

        .btn-buy-now {
            background-color: #ecf5ff !important;
            border-color: #b3d8ff !important;
            color: #409EFF !important;
        }

        .search-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            align-items: center;
        }

        .search-container .el-select {
            width: 200px;
        }

        .search-container .el-input {
            flex: 1;
        }

        .no-configs {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .no-configs a {
            color: #409EFF;
            text-decoration: none;
        }

        .no-configs a:hover {
            text-decoration: underline;
        }

        .load-more-container {
            padding: 20px 0;
        }

        .load-more-container .el-button {
            width: 120px;
        }

        .no-more-data {
            padding: 20px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
<div id="app" class="container">
    <!-- ÂØºËà™Ê†è -->
    <nav class="navbar">
        <a href="/user-config.html" class="navbar-brand">
            Êé¢Êé¢Á≥ñÊ¥ªÂä®Âπ≥Âè∞
        </a>
        <div class="navbar-nav">
            <a href="user-config.html" class="nav-link">
                üè† Áî®Êà∑ÈÖçÁΩÆ
            </a>
            <a href="activity-list.html" class="nav-link active">
                üéÅ Ê¥ªÂä®ÂàóË°®
            </a>
        </div>
    </nav>

    <!-- ‰∏ªÂÜÖÂÆπÂå∫ -->
    <el-card class="mt-4" style="border-radius: 12px; border: none; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);"
             v-loading="loading">
        <div slot="header" class="card-header">
            <span>Ê¥ªÂä®ÂàóË°®</span>
        </div>

        <!-- Áî®Êà∑ÈÖçÁΩÆÈÄâÊã©ÂíåÊêúÁ¥¢ -->
        <div class="search-container">
            <el-select v-model="selectedUserId" placeholder="ËØ∑ÈÄâÊã©Áî®Êà∑ÈÖçÁΩÆ" @change="fetchActivities">
                <el-option
                        v-for="config in userConfigs"
                        :key="config.user_id"
                        :label="config.name"
                        :value="config.user_id">
                </el-option>
            </el-select>

            <el-input
                    placeholder="ËØ∑ËæìÂÖ•ÂïÜÂìÅÊ†áÈ¢òÊêúÁ¥¢"
                    v-model="searchTitle"
                    clearable>
            </el-input>

            <el-button type="primary" @click="() => fetchActivities(true)" :disabled="loading">
                <i class="fa fa-search"></i> ÊêúÁ¥¢
            </el-button>
        </div>

        <!-- Êó†Áî®Êà∑ÈÖçÁΩÆÊèêÁ§∫ -->
        <div v-if="userConfigs.length === 0" class="no-configs">
            <el-empty description="ÊöÇÊó†Áî®Êà∑ÈÖçÁΩÆ">
                <p>ËØ∑ÂÖàÂàõÂª∫Áî®Êà∑ÈÖçÁΩÆ</p>
                <el-button type="primary" @click="goToUserConfig">
                    ÂâçÂæÄÁî®Êà∑ÈÖçÁΩÆÈ°µÈù¢
                </el-button>
            </el-empty>
        </div>

        <!-- Êó†Ê¥ªÂä®Êï∞ÊçÆ -->
        <div v-else-if="activities.length === 0 && !loading" class="no-configs">
            <el-empty description="ÊöÇÊó†Ê¥ªÂä®Êï∞ÊçÆ">
                <el-button type="primary" @click="fetchActivities" :disabled="loading">
                    <i class="fa fa-refresh"></i> Âà∑Êñ∞ÂàóË°®
                </el-button>
            </el-empty>
        </div>

        <!-- Ê¥ªÂä®Âç°ÁâáÂàóË°® -->
        <div v-else class="cards-container mt-4">
            <el-card
                    v-for="(activity, index) in activities"
                    :key="activity.activitygoods_id"
                    class="user-config-card"
                    :style="{animationDelay: (index * 0.1) + 's'}"
            >
                <div class="activity-card">
                    <img :src="activity.image" :alt="activity.title" class="activity-image"
                         onerror="this.src='https://via.placeholder.com/120'">

                    <div class="activity-content">
                        <div class="activity-title">{{ activity.title }}</div>

                        <div class="activity-info">
                            <div class="info-item">
                                <i class="fa fa-shopping-bag"></i>
                                <span>{{ activity.shop_name }}</span>
                            </div>
                        </div>

                        <div class="price-container">
                            <div class="current-price">¬•{{ activity.price }}</div>
                            <div class="original-price">¬•{{ activity.y_price }}</div>
                        </div>

                        <div class="activity-actions">
                            <el-button
                                    size="small"
                                    :class="getButtonClass(activity)"
                                    :disabled="isButtonDisabled(activity)"
                                    @click="handleActivityAction(activity)">
                                {{ getButtonText(activity) }}
                            </el-button>
                        </div>
                    </div>
                </div>
            </el-card>
        </div>

        <!-- Âä†ËΩΩÊõ¥Â§öÊåâÈíÆ -->
        <div v-if="activities.length > 0 && hasMore" class="load-more-container"
             style="text-align: center; margin-top: 20px;">
            <el-button @click="loadMore" :loading="loadingMore" type="primary" plain>
                {{ loadingMore ? 'Âä†ËΩΩ‰∏≠...' : 'Âä†ËΩΩÊõ¥Â§ö' }}
            </el-button>
        </div>

        <!-- Ê≤°ÊúâÊõ¥Â§öÊï∞ÊçÆÊèêÁ§∫ -->
        <div v-if="activities.length > 0 && !hasMore && !loading" class="no-more-data"
             style="text-align: center; margin-top: 20px; color: #999;">
            Ê≤°ÊúâÊõ¥Â§öÊï∞ÊçÆ‰∫Ü
        </div>
    </el-card>
</div>

<script>
    new Vue({
        el: '#app',
        data() {
            return {
                userConfigs: [],
                activities: [],
                selectedUserId: null,
                searchTitle: '',
                loading: false,
                pageNum: 1,
                pageSize: 10,
                hasMore: true,
                loadingMore: false
            }
        },
        mounted() {
            this.fetchUserConfigs();
        },
        methods: {
            // Ëé∑ÂèñÊâÄÊúâÁî®Êà∑ÈÖçÁΩÆ
            async fetchUserConfigs() {
                this.loading = true;
                try {
                    const response = await fetch('/ttt/user-configs')
                    const result = await response.json()
                    if (result.code === 200) {
                        this.userConfigs = result.data || []
                        // ÈªòËÆ§ÈÄâ‰∏≠Á¨¨‰∏Ä‰∏™
                        if (this.userConfigs.length > 0) {
                            this.selectedUserId = this.userConfigs[0].user_id
                            this.fetchActivities()
                        }
                    } else {
                        this.$message.error(result.msg || 'Ëé∑ÂèñÁî®Êà∑ÈÖçÁΩÆÂ§±Ë¥•')
                    }
                } catch (error) {
                    this.$message.error('ÁΩëÁªúÈîôËØØ: ' + error.message)
                } finally {
                    this.loading = false;
                }
            },

            // Ëé∑ÂèñÊ¥ªÂä®ÂàóË°®
            async fetchActivities(reset = true) {
                if (!this.selectedUserId) {
                    this.activities = []
                    return
                }

                if (reset) {
                    this.pageNum = 1
                    this.activities = []
                    this.hasMore = true
                }

                if (!this.hasMore && !reset) {
                    return
                }

                const loadingState = reset ? 'loading' : 'loadingMore'
                this[loadingState] = true;
                try {
                    const url = `/ttt/activity-list/${this.selectedUserId}?title=${encodeURIComponent(this.searchTitle)}&page_num=${this.pageNum}&page_size=${this.pageSize}`
                    const response = await fetch(url)
                    const result = await response.json()
                    if (result.code === 200) {
                        const newActivities = result.data || []
                        if (reset) {
                            this.activities = newActivities
                        } else {
                            this.activities = this.activities.concat(newActivities)
                        }

                        // Ê£ÄÊü•ÊòØÂê¶ËøòÊúâÊõ¥Â§öÊï∞ÊçÆ
                        this.hasMore = newActivities.length === this.pageSize
                        this.pageNum++
                    } else {
                        this.$message.error(result.msg || 'Ëé∑ÂèñÊ¥ªÂä®ÂàóË°®Â§±Ë¥•')
                    }
                } catch (error) {
                    this.$message.error('ÁΩëÁªúÈîôËØØ: ' + error.message)
                } finally {
                    this[loadingState] = false;
                }
            },

            // Âä†ËΩΩÊõ¥Â§öÊ¥ªÂä®
            async loadMore() {
                if (!this.loading && this.hasMore) {
                    await this.fetchActivities(false)
                }
            },

            // Ëé∑ÂèñÊåâÈíÆÊñáÊú¨
            getButtonText(activity) {
                if (activity.sy_store < 1) {
                    return 'Â∑≤Êä¢ÂÖâ'
                } else if (activity.sy_store > 0 && activity.kan === 0 && activity.is_cut === 2) {
                    return 'Á†ç‰ª∑'
                } else {
                    return 'Á´ãÂàªË¥≠‰π∞'
                }
            },

            // Ëé∑ÂèñÊåâÈíÆÊ†∑ÂºèÁ±ª
            getButtonClass(activity) {
                if (activity.sy_store < 1) {
                    return 'btn-sold-out'
                } else if (activity.sy_store > 0 && activity.kan === 0 && activity.is_cut === 2) {
                    return 'btn-bargain'
                } else {
                    return 'btn-buy-now'
                }
            },

            // Âà§Êñ≠ÊåâÈíÆÊòØÂê¶Á¶ÅÁî®
            isButtonDisabled(activity) {
                return activity.sy_store < 1
            },

            // Â§ÑÁêÜÊ¥ªÂä®Êìç‰Ωú
            handleActivityAction(activity) {
                if (activity.sy_store < 1) {
                    this.$message.info('ËØ•ÂïÜÂìÅÂ∑≤Êä¢ÂÖâ')
                    return
                } else if (activity.sy_store > 0 && activity.kan === 0 && activity.is_cut === 2) {
                    this.$message.info('ÊâßË°åÁ†ç‰ª∑Êìç‰Ωú: ' + activity.title)
                    // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Á†ç‰ª∑ÈÄªËæë
                } else {
                    this.$message.info('ÊâßË°åË¥≠‰π∞Êìç‰Ωú: ' + activity.title)
                    // ËøôÈáåÂèØ‰ª•Ê∑ªÂä†Ë¥≠‰π∞ÈÄªËæë
                }
            },

            // Ë∑≥ËΩ¨Âà∞Áî®Êà∑ÈÖçÁΩÆÈ°µÈù¢
            goToUserConfig() {
                window.location.href = '/user-config.html'
            }
        }
    })
</script>
</body>
</html>