<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›‘æ§æ´»åŠ¨ç®¡ç†</title>
    <!-- å¼•å…¥ Vue.js -->
    <script src="https://unpkg.com/vue@2/dist/vue.js"></script>
    <!-- å¼•å…¥ Element UI æ ·å¼ -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- å¼•å…¥ Font Awesome å›¾æ ‡ -->
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <!-- å¼•å…¥ Element UI ç»„ä»¶åº“ -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- å¼•å…¥ç›‘æ§æ´»åŠ¨ç®¡ç†é¡µé¢æ ·å¼ -->
    <link rel="stylesheet" href="css/monitor-activity.css">
</head>
<body>
<div id="app" class="container">
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <a href="/user-config.html" class="navbar-brand">
            æ¢æ¢ç³–æ´»åŠ¨å¹³å°
        </a>
        <div class="navbar-nav">
            <a href="user-config.html" class="nav-link">
                ğŸ  ç”¨æˆ·é…ç½®
            </a>
            <a href="activity-list.html" class="nav-link">
                ğŸ æ´»åŠ¨åˆ—è¡¨
            </a>
            <a href="monitor-activity.html" class="nav-link active">
                ğŸ“Š æ´»åŠ¨ç›‘æ§
            </a>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <el-card class="mt-4" style="border-radius: 12px; border: none; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);"
             v-loading="loading">
        <div slot="header" class="card-header">
            <span>ç›‘æ§æ´»åŠ¨ç®¡ç†</span>
            <div style="display: flex; gap: 10px;">
                <el-button class="add-address-btn" @click="fetchMonitorActivities" :disabled="loading"
                           style="display: flex; align-items: center; gap: 5px;">
                    <i class="fa fa-refresh"></i> åˆ·æ–°
                </el-button>
            </div>
        </div>

        <div v-if="monitorActivities.length === 0" class="empty-state">
            <el-empty description="æš‚æ— ç›‘æ§æ´»åŠ¨">
                <el-button class="add-address-btn" @click="fetchMonitorActivities" slot="bottom">
                    <i class="fa fa-refresh"></i> åˆ·æ–°åˆ—è¡¨
                </el-button>
            </el-empty>
        </div>

        <!-- ç›‘æ§æ´»åŠ¨å¡ç‰‡ -->
        <div v-else class="cards-container mt-4">
            <el-card
                    v-for="(activity, index) in monitorActivities"
                    :key="activity.m_id"
                    class="user-config-card"
                    :style="{animationDelay: (index * 0.1) + 's'}"
            >
                <div>
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fa fa-bell"></i> {{ activity.shop_name }}
                        </div>
                    </div>

                    <div class="card-content">
                        <div class="info-item">
                            <i class="fa fa-id-card"></i>
                            <span class="info-label">æ´»åŠ¨ID:</span>
                            <span class="info-value">{{ activity.m_id }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fa fa-user"></i>
                            <span class="info-label">ç”¨æˆ·å:</span>
                            <span class="info-value">{{ activity.username }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fa fa-tag"></i>
                            <span class="info-label">ç›‘æ§ç±»å‹:</span>
                            <span class="info-value">{{ getMonitorTypeText(activity.m_type) }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fa fa-usd"></i>
                            <span class="info-label">ä»·æ ¼é˜ˆå€¼:</span>
                            <span class="info-value">{{ activity.threshold_price }}</span>
                        </div>
                        <div class="info-item">
                            <i class="fa fa-line-chart"></i>
                            <span class="info-label">çŠ¶æ€:</span>
                            <span class="info-value">
                                <el-tag size="small" :type="getStatusType(activity.status)">
                                    {{ getStatusText(activity.status) }}
                                </el-tag>
                            </span>
                        </div>
                    </div>

                    <div class="card-footer">
                        <el-button size="small" class="edit-btn" @click="openEditDialog(activity)" :disabled="loading"
                                   style="display: flex; align-items: center; gap: 3px;">
                            <i class="fa fa-edit"></i> ç¼–è¾‘
                        </el-button>
                        <el-button size="small" class="delete-btn" @click="deleteMonitorActivity(activity.m_id)"
                                   :disabled="loading" style="display: flex; align-items: center; gap: 3px;">
                            <i class="fa fa-trash"></i> åˆ é™¤
                        </el-button>
                    </div>
                </div>
            </el-card>
        </div>
    </el-card>

    <!-- æ–°å¢/ç¼–è¾‘å¯¹è¯æ¡† -->
    <el-dialog :title="dialogTitle" :visible.sync="dialogVisible" width="90%" max-width="500px"
               @close="handleDialogClose">
        <el-form :model="currentActivity" label-width="100px">
            <el-form-item v-if="!isEditing" label="ç›‘æ§ç±»å‹">
                <el-select v-model="currentActivity.m_type" placeholder="è¯·é€‰æ‹©ç›‘æ§ç±»å‹">
                    <el-option label="ä½äºæŸå€¼æ—¶æé†’" :value="1"></el-option>
                </el-select>
            </el-form-item>
            <el-form-item v-if="!isEditing" label="é—¨åº—åç§°">
                <el-input v-model="currentActivity.shop_name" placeholder="è¯·è¾“å…¥é—¨åº—åç§°"></el-input>
            </el-form-item>
            <el-form-item v-if="!isEditing" label="ç”¨æˆ·ID">
                <el-input v-model.number="currentActivity.user_id" placeholder="è¯·è¾“å…¥ç”¨æˆ·ID"></el-input>
            </el-form-item>
            <el-form-item label="ä»·æ ¼é˜ˆå€¼">
                <el-input v-model.number="currentActivity.threshold_price" placeholder="è¯·è¾“å…¥ä»·æ ¼é˜ˆå€¼"></el-input>
            </el-form-item>
            <el-form-item label="çŠ¶æ€">
                <el-select v-model="currentActivity.status" placeholder="è¯·é€‰æ‹©çŠ¶æ€">
                    <el-option label="æ­£å¸¸" :value="1"></el-option>
                    <el-option label="æš‚åœ" :value="2"></el-option>
                </el-select>
            </el-form-item>
        </el-form>
        <span slot="footer" class="dialog-footer">
            <el-button @click="dialogVisible = false">å– æ¶ˆ</el-button>
            <el-button type="primary" @click="saveMonitorActivity" :loading="submitLoading">ç¡® å®š</el-button>
        </span>
    </el-dialog>
</div>

<script>
    new Vue({
        el: '#app',
        data() {
            return {
                monitorActivities: [],
                dialogVisible: false,
                isEditing: false,
                loading: false,
                submitLoading: false,
                currentActivity: {
                    m_type: 1,
                    shop_name: '',
                    user_id: null,
                    status: 1,
                    threshold_price: null
                }
            }
        },
        computed: {
            dialogTitle() {
                return this.isEditing ? 'ç¼–è¾‘ç›‘æ§æ´»åŠ¨' : 'æ–°å¢ç›‘æ§æ´»åŠ¨'
            }
        },
        mounted() {
            this.fetchMonitorActivities()
        },
        methods: {
            // è·å–æ‰€æœ‰ç›‘æ§æ´»åŠ¨
            async fetchMonitorActivities() {
                this.loading = true;
                try {
                    const response = await fetch('/ttt/monitor-activities')
                    const result = await response.json()
                    if (result.code === 200) {
                        this.monitorActivities = result.data || []
                    } else {
                        this.$message.error(result.msg || 'è·å–ç›‘æ§æ´»åŠ¨å¤±è´¥')
                    }
                } catch (error) {
                    this.$message.error('ç½‘ç»œé”™è¯¯: ' + error.message)
                } finally {
                    this.loading = false;
                }
            },

            // æ‰“å¼€æ–°å¢å¯¹è¯æ¡†
            openAddDialog() {
                this.isEditing = false
                this.currentActivity = {
                    m_type: 1,
                    shop_name: '',
                    user_id: null,
                    status: 1,
                    threshold_price: null
                }
                this.dialogVisible = true
            },

            // æ‰“å¼€ç¼–è¾‘å¯¹è¯æ¡†
            openEditDialog(activity) {
                this.isEditing = true
                // æ·±æ‹·è´é¿å…ä¿®æ”¹åŸæ•°æ®
                this.currentActivity = JSON.parse(JSON.stringify(activity))
                this.dialogVisible = true
            },

            // å¯¹è¯æ¡†å…³é—­å›è°ƒ
            handleDialogClose() {
                // å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›æ¸…ç†å·¥ä½œ
            },

            // ä¿å­˜ç›‘æ§æ´»åŠ¨
            async saveMonitorActivity() {
                this.submitLoading = true;
                try {
                    let response
                    if (this.isEditing) {
                        // ç¼–è¾‘
                        response = await fetch(`/ttt/monitor-activities/${this.currentActivity.m_id}/update`, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.currentActivity)
                        })
                    } else {
                        // æ–°å¢
                        response = await fetch('/ttt/monitor-activities/create', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(this.currentActivity)
                        })
                    }

                    const result = await response.json()
                    if (result.code === 200) {
                        this.$message.success(this.isEditing ? 'ç¼–è¾‘æˆåŠŸ' : 'æ–°å¢æˆåŠŸ')
                        this.dialogVisible = false
                        this.fetchMonitorActivities()
                    } else {
                        this.$message.error(result.msg || (this.isEditing ? 'ç¼–è¾‘å¤±è´¥' : 'æ–°å¢å¤±è´¥'))
                    }
                } catch (error) {
                    this.$message.error('ç½‘ç»œé”™è¯¯: ' + error.message)
                } finally {
                    this.submitLoading = false;
                }
            },

            // åˆ é™¤ç›‘æ§æ´»åŠ¨
            deleteMonitorActivity(mId) {
                this.$confirm('æ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤è¯¥ç›‘æ§æ´»åŠ¨, æ˜¯å¦ç»§ç»­?', 'æç¤º', {
                    confirmButtonText: 'ç¡®å®š',
                    cancelButtonText: 'å–æ¶ˆ',
                    type: 'warning'
                }).then(async () => {
                    this.loading = true;
                    try {
                        const response = await fetch(`/ttt/monitor-activities/${mId}/delete`, {
                            method: 'DELETE'
                        })
                        const result = await response.json()
                        if (result.code === 200) {
                            this.$message.success('åˆ é™¤æˆåŠŸ')
                            this.fetchMonitorActivities()
                        } else {
                            this.$message.error(result.msg || 'åˆ é™¤å¤±è´¥')
                        }
                    } catch (error) {
                        this.$message.error('ç½‘ç»œé”™è¯¯: ' + error.message)
                    } finally {
                        this.loading = false;
                    }
                }).catch(() => {
                    this.$message.info('å·²å–æ¶ˆåˆ é™¤')
                })
            },

            // è·å–ç›‘æ§ç±»å‹æ–‡æœ¬
            getMonitorTypeText(type) {
                const typeMap = {
                    1: 'ä½äºæŸå€¼æ—¶æé†’'
                }
                return typeMap[type] || 'æœªçŸ¥ç±»å‹'
            },

            // è·å–çŠ¶æ€æ–‡æœ¬
            getStatusText(status) {
                const statusMap = {
                    1: 'æ­£å¸¸',
                    2: 'æš‚åœ'
                }
                return statusMap[status] || 'æœªçŸ¥çŠ¶æ€'
            },

            // è·å–çŠ¶æ€æ ·å¼ç±»å‹
            getStatusType(status) {
                switch (status) {
                    case 1:
                        return 'success';  // æ­£å¸¸
                    case 2:
                        return 'warning';  // æš‚åœ
                    default:
                        return 'info';
                }
            }
        }
    })
</script>
</body>
</html>